import streamlit as st
import PyPDF2
import re
import google.generativeai as genai
import os
from dotenv import load_dotenv

# ----------------- Setup -----------------
load_dotenv()
genai.configure(api_key=os.getenv("GOOGLE_API_KEY"))

st.set_page_config(page_title="Mental Health Risk Predictor", layout="centered")

# ----------------- Title and Header -----------------
st.markdown("""
    <h1 style='text-align: center; color: #800080;'>üß† Suicide Risk Predictor</h1>
    <h4 style='text-align: center; color: #444;'>PDF Report + Gemini AI + Mental Health Questionnaire</h4>
""", unsafe_allow_html=True)

# ----------------- Questionnaire -----------------
questions = [
    "Do you often feel hopeless or down?",
    "Do you have trouble sleeping or experience nightmares?",
    "Have you had thoughts of self-harm or suicide recently?",
    "Do you feel isolated or withdrawn from others?",
    "Do you experience sudden mood swings or aggression?",
    "Are you currently taking any medications for mental health?",
    "Do you feel anxious or panicked regularly?"
]

# ----------------- Helper Functions -----------------
def extract_text_from_pdf(uploaded_file):
    reader = PyPDF2.PdfReader(uploaded_file)
    return " ".join([page.extract_text() for page in reader.pages if page.extract_text()])

def clean_text(text):
    return re.sub(r'\s+', ' ', text.strip())

def extract_counselor_section(text):
    match = re.search(r'--- COUNSELOR REPORT ---(.+)', text, re.IGNORECASE | re.DOTALL)
    return match.group(1).strip() if match else ""

def get_gemini_risk_score(text):
    prompt = f"""
Analyze this counselor note and return a risk score (0‚Äì3):
- 0 = No signs of suicidal thoughts
- 1 = Mild distress
- 2 = Concerning signs
- 3 = Suicidal ideation

Counselor Notes: '''{text}'''
ONLY return the number.
"""
    model = genai.GenerativeModel(model_name="gemini-pro")
    try:
        response = model.generate_content(prompt)
        return min(3, max(0, int(response.text.strip())))
    except:
        return 1  # fallback if model fails

def evaluate_medical_section(text):
    score = 0
    if re.search(r'Blood Pressure:\s*(\d{2,3})/(\d{2,3})', text):
        bp = re.search(r'Blood Pressure:\s*(\d{2,3})/(\d{2,3})', text)
        if int(bp.group(1)) > 140 or int(bp.group(2)) > 90:
            score += 1
    if re.search(r'Cortisol Level:\s*(\d+)', text):
        if int(re.search(r'Cortisol Level:\s*(\d+)', text).group(1)) > 20:
            score += 1
    if "Serotonin Level: Low" in text:
        score += 1
    if re.search(r'Heart Rate:\s*(\d+)', text):
        if int(re.search(r'Heart Rate:\s*(\d+)', text).group(1)) > 100:
            score += 1
    return score

def calculate_final_score(medical, counselor, questionnaire):
    return (medical * 0.3 + counselor * 0.4 + questionnaire * 0.3) / 4 * 100

# ----------------- Upload Section -----------------
st.markdown("<h4 style='text-align:center;'>üìÑ Upload Combined Medical + Counselor Report (PDF)</h4>", unsafe_allow_html=True)
uploaded_file = st.file_uploader("Choose a PDF file", type=["pdf"])

# ----------------- Main Logic -----------------
if uploaded_file:
    raw_text = extract_text_from_pdf(uploaded_file)
    cleaned_text = clean_text(raw_text)
    counselor_text = extract_counselor_section(cleaned_text)

    # ---- Physical Evaluation ----
    st.markdown("### ü©∫ <span style='color:#2E8B57;'>Physical Health Evaluation</span>", unsafe_allow_html=True)
    med_score = evaluate_medical_section(cleaned_text)
    st.markdown(f"<b>Medical Score:</b> <span style='color:#00008B'>{med_score}/4</span>", unsafe_allow_html=True)

    # ---- Gemini Analysis ----
    st.markdown("### üß† <span style='color:#8B008B;'>Gemini Counselor Risk Analysis</span>", unsafe_allow_html=True)
    with st.spinner("Analyzing counselor notes..."):
        counselor_score = get_gemini_risk_score(counselor_text)
    st.markdown(f"<b>Gemini Counselor Score:</b> <span style='color:#00008B'>{counselor_score}/3</span>", unsafe_allow_html=True)

    # ---- Questionnaire ----
    st.markdown("""
        <style>
        .question-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        </style>
    """, unsafe_allow_html=True)

    st.markdown("### üìù <span style='color:#DAA520;'>Mental Health Questionnaire</span>", unsafe_allow_html=True)

    auto_fill_no = (med_score <= 1 and counselor_score <= 1)
    q_score = 0
    for idx, q in enumerate(questions, 1):
        default = "No" if auto_fill_no else None
        with st.container():
            st.markdown(f"<div class='question-card'><strong>Q{idx}:</strong> {q}</div>", unsafe_allow_html=True)
            ans = st.radio("Select an answer:", ["Yes", "No"], key=f"q{idx}", index=1 if default == "No" else 0)
            if ans == "Yes":
                q_score += 1
    q_score = min(q_score, 4)
    st.markdown(f"<b>Questionnaire Score:</b> <span style='color:#00008B'>{q_score}/4</span>", unsafe_allow_html=True)

    # ---- Final Score ----
    final_score = calculate_final_score(med_score, counselor_score, q_score)
    st.markdown(f"""
        <div style='margin-top: 20px; padding: 15px; background-color: #e0e0ff; border-radius: 12px;'>
            <h3 style='color: #4B0082;'>üìä Final Suicidal Risk Estimate</h3>
            <p style='font-size: 26px; color: #FF4500;'><b>{final_score:.2f}% Risk</b></p>
        </div>
    """, unsafe_allow_html=True)

    # ---- Risk Level Alert ----
    with st.container():
        if final_score >= 70:
            st.markdown("""
                <div style="padding: 15px; background-color: #ffe6e6; border-radius: 10px; border: 2px solid red;">
                    üî¥ <strong>High Risk Detected</strong><br>
                    Immediate professional help is strongly recommended.<br>
                    <em>You are not alone ‚Äî support is available.</em>
                </div>
            """, unsafe_allow_html=True)
        elif final_score >= 40:
            st.markdown("""
                <div style="padding: 15px; background-color: #fff3cd; border-radius: 10px; border: 2px solid #ffcc00;">
                    üü† <strong>Moderate Risk Detected</strong><br>
                    Caution advised. Keep monitoring and talk to someone you trust.
                </div>
            """, unsafe_allow_html=True)
        else:
            st.markdown("""
                <div style="padding: 15px; background-color: #d4edda; border-radius: 10px; border: 2px solid #28a745;">
                    üü¢ <strong>Low Risk Detected</strong><br>
                    You're doing well! Keep it up üí™
                </div>
            """, unsafe_allow_html=True)

    # ---- Footer ----
    st.markdown("""
        <hr>
        <p style="font-size: 12px; color: gray;">
            ‚ö†Ô∏è This is an educational tool and not a replacement for professional mental health advice. If you're in crisis, please seek help.
        </p>
    """, unsafe_allow_html=True)
